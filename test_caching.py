#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
"""

import asyncio
import logging
from cache import cache_manager, user_cache, document_cache, initialize_caching, shutdown_caching

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
logging.basicConfig(level=logging.INFO, format='%(name)s - %(levelname)s - %(message)s')


async def test_caching_system():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    await initialize_caching()
    
    try:
        # –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        print("\n1. –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:")
        
        # –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        call_count = 0
        
        @cache_manager.cache_result(ttl=2, key_prefix="test")  # TTL 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∞
        async def expensive_operation(x, y):
            nonlocal call_count
            call_count += 1
            await asyncio.sleep(0.1)  # –ò–º–∏—Ç–∏—Ä—É–µ–º –º–µ–¥–ª–µ–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
            return x + y
        
        # –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ - –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
        print("   –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ (–¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è)...")
        result1 = await expensive_operation(5, 3)
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {result1}, –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: {call_count}")
        
        # –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –∫—ç—à–∞
        print("   –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –∫—ç—à–∞)...")
        result2 = await expensive_operation(5, 3)
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {result2}, –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: {call_count}")
        
        # –¢—Ä–µ—Ç–∏–π –≤—ã–∑–æ–≤ —Å –¥—Ä—É–≥–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ - –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
        print("   –¢—Ä–µ—Ç–∏–π –≤—ã–∑–æ–≤ —Å –¥—Ä—É–≥–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ (–¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è)...")
        result3 = await expensive_operation(10, 20)
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {result3}, –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: {call_count}")
        
        if call_count == 2:
            print("   ‚úÖ –ë–∞–∑–æ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
        else:
            print(f"   ‚ùå –û—à–∏–±–∫–∞: –æ–∂–∏–¥–∞–ª–æ—Å—å 2 –≤—ã–∑–æ–≤–∞, –ø–æ–ª—É—á–µ–Ω–æ {call_count}")
        
        # –¢–µ—Å—Ç 2: –ö—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        print("\n2. –¢–µ—Å—Ç –∫—ç—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:")
        print("   –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
        user_data1 = await user_cache.get_user_profile(123)
        print("   –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –∫—ç—à–∞)...")
        user_data2 = await user_cache.get_user_profile(123)
        print(f"   –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_data1}")
        print("   ‚úÖ –ö—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç")
        
        # –¢–µ—Å—Ç 3: –ö—ç—à –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        print("\n3. –¢–µ—Å—Ç –∫—ç—à–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:")
        print("   –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞...")
        doc_info1 = await document_cache.get_document_info("doc_001")
        print("   –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Ç–æ–≥–æ –∂–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –∫—ç—à–∞)...")
        doc_info2 = await document_cache.get_document_info("doc_001")
        print(f"   –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ: {doc_info1}")
        print("   ‚úÖ –ö—ç—à –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        
        # –¢–µ—Å—Ç 4: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
        print("\n4. –¢–µ—Å—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞:")
        stats_before = cache_manager.memory_cache.get_stats()
        user_cache.invalidate_user_cache(123)
        stats_after = cache_manager.memory_cache.get_stats()
        print(f"   –ó–∞–ø–∏—Å–µ–π –¥–æ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏: {stats_before['active_items']}")
        print(f"   –ó–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏: {stats_after['active_items']}")
        print("   ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        
        # –¢–µ—Å—Ç 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
        print("\n5. –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞:")
        stats = cache_manager.memory_cache.get_stats()
        print(f"   –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {stats['total_items']}")
        print(f"   –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: {stats['active_items']}")
        print(f"   –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: {stats['expired_items']}")
        print(f"   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {stats['memory_usage']}")
        print("   ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        
        # –¢–µ—Å—Ç 6: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞
        print("\n6. –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞:")
        print("   –ñ–¥—ë–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–∫–∏ TTL —Ç–µ—Å—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏...")
        await asyncio.sleep(3)
        
        # –í—ã–∑—ã–≤–∞–µ–º –æ—á–∏—Å—Ç–∫—É –≤—Ä—É—á–Ω—É—é
        cleaned = cache_manager.memory_cache.cleanup_expired()
        print(f"   –û—á–∏—â–µ–Ω–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: {cleaned}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫—ç—à –æ—á–∏—Å—Ç–∏–ª—Å—è
        final_stats = cache_manager.memory_cache.get_stats()
        print(f"   –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {final_stats['active_items']}")
        print("   ‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        
        print(f"\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        print("‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        raise
        
    finally:
        # –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        await shutdown_caching()


if __name__ == "__main__":
    asyncio.run(test_caching_system())
